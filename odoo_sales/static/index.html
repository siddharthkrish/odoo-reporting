<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Odoo Sales Report</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f6fa;
      color: #1a1a2e;
      min-height: 100vh;
    }

    header {
      background: #1a1a2e;
      color: #fff;
      padding: 1.25rem 2rem;
    }
    header h1 { font-size: 1.25rem; font-weight: 600; }

    main { max-width: 1100px; margin: 2rem auto; padding: 0 1.5rem; }

    /* Controls */
    .controls {
      background: #fff;
      border-radius: 10px;
      padding: 1.25rem 1.5rem;
      display: flex;
      align-items: flex-end;
      gap: 1rem;
      flex-wrap: wrap;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
      margin-bottom: 1.5rem;
    }
    .field { display: flex; flex-direction: column; gap: .35rem; }
    label { font-size: .8rem; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; color: #666; }
    input[type="date"] {
      padding: .5rem .75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: .95rem;
      color: #1a1a2e;
      background: #fff;
    }
    input[type="date"]:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,.15); }

    button#fetch {
      padding: .55rem 1.4rem;
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: .95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
      white-space: nowrap;
    }
    button#fetch:hover { background: #4f46e5; }
    button#fetch:disabled { background: #a5b4fc; cursor: not-allowed; }

    /* Summary cards */
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 1.1rem 1.25rem;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
    }
    .card .label { font-size: .75rem; font-weight: 600; text-transform: uppercase; letter-spacing: .05em; color: #9ca3af; margin-bottom: .3rem; }
    .card .value { font-size: 1.6rem; font-weight: 700; color: #1a1a2e; }

    /* Chart */
    .chart-box {
      background: #fff;
      border-radius: 10px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
      margin-bottom: 1.5rem;
    }
    #chart { width: 100%; height: 340px; }

    /* Table */
    .table-box {
      background: #fff;
      border-radius: 10px;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,.08);
      overflow-x: auto;
    }
    .table-box h2 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; font-size: .9rem; }
    th {
      text-align: left;
      padding: .6rem .75rem;
      font-size: .75rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #9ca3af;
      border-bottom: 2px solid #f3f4f6;
    }
    td { padding: .65rem .75rem; border-bottom: 1px solid #f3f4f6; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }
    .amount { font-variant-numeric: tabular-nums; text-align: right; }
    th.amount { text-align: right; }

    /* States */
    #status {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
      font-size: .95rem;
      display: none;
    }
    #error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      border-radius: 8px;
      padding: .85rem 1.1rem;
      margin-bottom: 1.5rem;
      display: none;
      font-size: .9rem;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<header>
  <h1>Odoo Sales Report</h1>
</header>

<main>
  <div class="controls">
    <div class="field">
      <label for="date-from">From</label>
      <input type="date" id="date-from" />
    </div>
    <div class="field">
      <label for="date-to">To</label>
      <input type="date" id="date-to" />
    </div>
    <button id="fetch">Fetch</button>
  </div>

  <div id="error"></div>
  <p id="status">Loading…</p>

  <div id="results" class="hidden">
    <div class="summary">
      <div class="card">
        <div class="label">Orders</div>
        <div class="value" id="stat-count">—</div>
      </div>
      <div class="card">
        <div class="label">Total Revenue</div>
        <div class="value" id="stat-total">—</div>
      </div>
      <div class="card">
        <div class="label">Avg. Order Value</div>
        <div class="value" id="stat-avg">—</div>
      </div>
    </div>

    <div class="chart-box">
      <div id="chart"></div>
    </div>

    <div class="table-box">
      <h2>Orders</h2>
      <table>
        <thead>
          <tr>
            <th>Order</th>
            <th>Date</th>
            <th>Customer</th>
            <th class="amount">Amount</th>
            <th>Currency</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
  // Default date range: current month
  const today = new Date();
  const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  document.getElementById('date-from').value = isoDate(firstOfMonth);
  document.getElementById('date-to').value = isoDate(today);

  document.getElementById('fetch').addEventListener('click', fetchSales);

  async function fetchSales() {
    const from = document.getElementById('date-from').value;
    const to = document.getElementById('date-to').value;

    if (!from || !to) { showError('Please select both a start and end date.'); return; }
    if (from > to) { showError('Start date must be before end date.'); return; }

    setLoading(true);
    hideError();

    try {
      const res = await fetch(`/api/sales?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
      const data = await res.json();
      if (!res.ok) { showError(data.detail || 'An error occurred.'); return; }
      render(data);
    } catch (err) {
      showError('Network error — is the server running?');
    } finally {
      setLoading(false);
    }
  }

  function render(orders) {
    document.getElementById('results').classList.remove('hidden');

    // Summary stats
    const total = orders.reduce((s, o) => s + o.amount_total, 0);
    const avg = orders.length ? total / orders.length : 0;
    document.getElementById('stat-count').textContent = orders.length.toLocaleString();
    document.getElementById('stat-total').textContent = formatAmount(total);
    document.getElementById('stat-avg').textContent = formatAmount(avg);

    // Chart — aggregate by date
    const byDate = {};
    for (const o of orders) {
      const day = o.date_order.slice(0, 10);
      byDate[day] = (byDate[day] || 0) + o.amount_total;
    }
    const dates = Object.keys(byDate).sort();
    const amounts = dates.map(d => byDate[d]);

    Plotly.react('chart', [{
      type: 'bar',
      x: dates,
      y: amounts,
      marker: { color: '#6366f1' },
      hovertemplate: '<b>%{x}</b><br>%{y:,.2f}<extra></extra>',
    }], {
      margin: { t: 20, r: 20, b: 50, l: 70 },
      xaxis: { type: 'date', tickformat: '%b %d', gridcolor: '#f3f4f6' },
      yaxis: { tickformat: ',.0f', gridcolor: '#f3f4f6' },
      plot_bgcolor: '#fff',
      paper_bgcolor: '#fff',
      font: { family: 'system-ui, -apple-system, sans-serif', size: 12, color: '#6b7280' },
    }, { responsive: true, displayModeBar: false });

    // Table
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    if (orders.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#9ca3af;padding:2rem">No orders found for this period.</td></tr>';
      return;
    }
    for (const o of orders) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(o.name)}</td>
        <td>${o.date_order.slice(0, 10)}</td>
        <td>${esc(o.partner_name || '—')}</td>
        <td class="amount">${formatAmount(o.amount_total)}</td>
        <td>${esc(o.currency_name || '—')}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function formatAmount(n) {
    return n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function isoDate(d) {
    return d.toISOString().slice(0, 10);
  }

  function setLoading(on) {
    const btn = document.getElementById('fetch');
    const status = document.getElementById('status');
    btn.disabled = on;
    btn.textContent = on ? 'Loading…' : 'Fetch';
    status.style.display = on ? 'block' : 'none';
  }

  function showError(msg) {
    const el = document.getElementById('error');
    el.textContent = msg;
    el.style.display = 'block';
    document.getElementById('results').classList.add('hidden');
  }

  function hideError() {
    document.getElementById('error').style.display = 'none';
  }
</script>
</body>
</html>
